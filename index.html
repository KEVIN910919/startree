<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>æ˜Ÿæ¨¹å·¥åŠï½œå·¥å–®èŠå¤©å®¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body{
  margin:0;
  font-family:system-ui;
  background:radial-gradient(circle at top,#45bfc2,#31999c,#1b6e73);
  color:#fff;
}
header{
  padding:14px 20px;
  background:linear-gradient(90deg,#2fa3a6,#1f6f73);
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 12px #0006;
}
.layout{display:flex;height:calc(100vh - 60px);}
.sidebar{
  width:240px;
  background:#0f3f43;
  padding:10px;
  overflow-y:auto;
  box-shadow:inset -1px 0 0 #0006;
}
.ticket{
  padding:10px;
  border-radius:10px;
  margin-bottom:6px;
  cursor:pointer;
  background:#145a60;
  transition:.15s;
}
.ticket:hover{filter:brightness(1.1);}
.ticket.active{
  background:linear-gradient(135deg,#4fd2d5,#31999c);
  color:#08383b;
  font-weight:600;
}
.main{flex:1;padding:20px;}
.card{
  background:rgba(10,40,42,.9);
  border-radius:18px;
  padding:16px;
  box-shadow:0 0 25px #0007;
}
#messages{
  height:55vh;
  overflow-y:auto;
  background:#0b2e31;
  border-radius:12px;
  padding:12px;
  margin:10px 0;
}
.msg{
  margin:6px 0;
  font-size:14px;
  display:flex;
  gap:6px;
  align-items:center;
}
.site{color:#9af2f4;}
.dc{color:#ffd38c;}
.tag{
  font-size:12px;
  padding:2px 6px;
  border-radius:6px;
}
.tag.admin{background:#d9534f;}
.tag.artist{background:#4fd29a;}
.tag.client{background:#4fb5d2;}

#sendBar{display:flex;gap:8px;}
textarea{
  flex:1;
  background:#0b2e31;
  border:none;
  color:#fff;
  padding:10px;
  border-radius:10px;
}
textarea:focus{outline:2px solid #4fd2d5;}

button{
  background:linear-gradient(135deg,#4fd2d5,#31999c);
  border:none;
  color:#053436;
  padding:10px 14px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}
button:hover{filter:brightness(1.1);}
button.danger{
  background:linear-gradient(135deg,#e86a6a,#c73737);
  color:#fff;
}
.actions{display:flex;gap:8px;margin:8px 0;}
.locked{opacity:.5;pointer-events:none;}

#confirmMask{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.confirmBox{
  background:#0b3f42;
  padding:20px;
  border-radius:14px;
  width:280px;
  text-align:center;
  box-shadow:0 0 30px #0009;
}
.confirmBox h3{margin:0 0 10px;}
.confirmBtns{display:flex;gap:10px;justify-content:center;margin-top:14px;}
.confirmBtns button{min-width:90px;}
  
</style>
</head>
<body>
<header>
  <div>ğŸŒ² æ˜Ÿæ¨¹å·¥åŠï½œå§”è¨—å·¥å–®ç³»çµ±</div>
  <div id="userArea"></div>
</header>

<div id="loginBox" style="display:none; padding:40px;">
  <div class="card" style="max-width:420px;margin:auto;text-align:center;">
    <h2>ç™»å…¥æ˜Ÿæ¨¹å·¥åŠ</h2>
    <p>è«‹ä½¿ç”¨ Discord å¸³è™Ÿç™»å…¥ä»¥åŒæ­¥å·¥å–®èˆ‡èŠå¤©ã€‚</p>
    <button onclick="login()">ä½¿ç”¨ Discord ç™»å…¥</button>
  </div>
</div>
  
<div class="layout" id="chatLayout" style="display:none;">
  <div class="sidebar">
    <h3>ğŸ“ æˆ‘çš„å·¥å–®</h3>
    <div id="ticketList"></div>
  </div>

  <div class="main">
    <div class="card" id="chatCard">
      <div id="ticketInfo"></div>
      <div class="actions" id="ticketActions">
        <button class="danger" onclick="cancelTicket()">ğŸ›‘ ä¸­æ­¢å§”è¨—</button>
        <button class="danger" onclick="closeTicket()">ğŸ”’ çµå–®</button>
      </div>
      <div id="messages"></div>
      <div id="sendBar">
        <textarea id="msgInput" rows="2" placeholder="è¼¸å…¥è¨Šæ¯â€¦"></textarea>
        <button onclick="sendMsg()">é€å‡º</button>
      </div>
    </div>
  </div>
</div>

<!-- è‡ªè¨‚ç¢ºèªè¦–çª— -->
<div id="confirmMask" style="display:none;">
  <div class="confirmBox">
    <h3 id="confirmTitle">ç¢ºèªæ“ä½œ</h3>
    <p id="confirmText"></p>
    <div class="confirmBtns">
      <button id="confirmYes">ç¢ºå®š</button>
      <button id="confirmNo" class="danger">å–æ¶ˆ</button>
    </div>
  </div>
</div>
  
<script>
function login(){
  window.open(API+"/auth/discord","dcLogin","width=500,height=700");
}
  
const API="https://api.dreamlight.site";
let currentTicket=null,timer=null,lastId=0,seenIds=new Set();

// ===== ç™»å…¥ =====
window.addEventListener("message",(e)=>{
  if(e.data?.token){
    localStorage.setItem("token",e.data.token);
    checkLogin();
  }
});

async function checkLogin(){
  const token=localStorage.getItem("token");
  if(!token){
    loginBox.style.display="block";
    chatLayout.style.display="none";
    userArea.innerHTML="";
    return;
  }
  const r=await fetch(API+"/api/me",{headers:{Authorization:"Bearer "+token}});
  const d=await r.json();
  if(d.error){
    loginBox.style.display="block";
    chatLayout.style.display="none";
    return;
  }
  loginBox.style.display="none";
  chatLayout.style.display="flex";
  userArea.innerHTML=`ğŸ‘¤ ${d.username} <button class="danger" onclick="logout()">ç™»å‡º</button>`;
  loadTicketList();
}

function logout(){
  localStorage.removeItem("token");
  location.reload();
}

// ===== å·¥å–®åˆ—è¡¨ =====
async function loadTicketList(){
  const token = localStorage.getItem("token");
  const r = await fetch(API+"/api/my-tickets", {
    headers:{ Authorization:"Bearer "+token }
  });
  const rows = await r.json();

  ticketList.innerHTML = "";

  if(!rows.length){
    const tip = document.createElement("div");
    tip.style.opacity = "0.7";
    tip.style.fontSize = "14px";
    tip.style.padding = "8px";
    tip.textContent = "ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„å·¥å–®";
    ticketList.appendChild(tip);
    return;
  }

  rows.forEach((t,i)=>{
    const div = document.createElement("div");
    div.className = "ticket";
    div.textContent = t.ticket_code;
    div.onclick = ()=>selectTicket(t.ticket_code);
    ticketList.appendChild(div);
    if(i === 0) selectTicket(t.ticket_code);
  });
}

function selectTicket(code){
  document.querySelectorAll(".ticket").forEach(d=>{
    d.classList.toggle("active",d.textContent===code);
  });
  loadChat(code);
}

// ===== èŠå¤© =====
function roleTag(role){
  if(role==="admin")return `<span class="tag admin">ç®¡ç†å“¡</span>`;
  if(role==="artist")return `<span class="tag artist">ç¹ªå¸«</span>`;
  return `<span class="tag client">å§”è¨—äºº</span>`;
}

async function loadChat(code){
  if(currentTicket===code)return;
  currentTicket=code;
  lastId=0;seenIds.clear();
  messages.innerHTML="";
  ticketInfo.innerHTML=`ç›®å‰å·¥å–®ï¼š<b>${code}</b>`;
  await refreshChat();
  if(timer)clearInterval(timer);
  timer=setInterval(refreshChat,3000);
}

async function refreshChat(){
  if(!currentTicket)return;
  await checkTicketStatus();
  const r=await fetch(API+`/api/chat/${currentTicket}?after=${lastId}`);
  const rows=await r.json();
  rows.forEach(m=>{
    if(seenIds.has(m.id))return;
    seenIds.add(m.id);
    const div=document.createElement("div");
    div.className="msg "+(m.from_site?"site":"dc");
    div.innerHTML=`${roleTag(m.role)} <b>${m.username}</b>ï¼š${m.content}`;
    messages.appendChild(div);
    lastId=Math.max(lastId,m.id);
  });
  if(rows.length)messages.scrollTop=messages.scrollHeight;
}

// ===== ç‹€æ…‹æª¢æŸ¥ & é–å®š =====
async function checkTicketStatus(){
  const token=localStorage.getItem("token");
  const r=await fetch(API+`/api/ticket/${currentTicket}/status`,{
    headers:{Authorization:"Bearer "+token}
  });
  const d=await r.json();
  if(d.status==="cancelled"||d.status==="archived"){
    lockChat(d.status);
  }
}

function lockChat(status){
  chatCard.classList.add("locked");
  msgInput.disabled=true;
  sendBar.querySelector("button").disabled=true;
  msgInput.placeholder =
    status==="cancelled"
      ? "æ­¤å·¥å–®å·²ä¸­æ­¢ï¼Œç„¡æ³•å†æ“ä½œ"
      : "æ­¤å·¥å–®å·²çµå–®ï¼ŒèŠå¤©å®¤å·²é—œé–‰";
}

// ===== ç™¼é€ =====
async function sendMsg(){
  const v=msgInput.value.trim();
  if(!v||!currentTicket)return;
  const token=localStorage.getItem("token");
  msgInput.value="";
  await fetch(API+"/api/chat/send",{
    method:"POST",
    headers:{"Content-Type":"application/json",Authorization:"Bearer "+token},
    body:JSON.stringify({ticket_code:currentTicket,content:v})
  });
}

// ===== å·¥å–®æ“ä½œ =====
function cancelTicket(){
  showConfirm("ç¢ºå®šè¦ä¸­æ­¢å§”è¨—ï¼Ÿ", async ()=>{
    const token = localStorage.getItem("token");
    await fetch(API+"/api/ticket/cancel",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        Authorization:"Bearer "+token
      },
      body:JSON.stringify({ticket_code: currentTicket})
    });
    alert("å·²é€å‡ºä¸­æ­¢è«‹æ±‚");
  });
}

function closeTicket(){
  showConfirm("ç¢ºå®šè¦çµå–®ï¼Ÿ", async ()=>{
    const token = localStorage.getItem("token");
    await fetch(API+"/api/ticket/close",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        Authorization:"Bearer "+token
      },
      body:JSON.stringify({ticket_code: currentTicket})
    });
    alert("å·²é€å‡ºçµå–®è«‹æ±‚");
  });
}

checkLogin();

let confirmCallback = null;

function showConfirm(text, cb){
  confirmCallback = cb;
  document.getElementById("confirmText").textContent = text;
  document.getElementById("confirmMask").style.display = "flex";
}

function closeConfirm(){
  document.getElementById("confirmMask").style.display = "none";
  confirmCallback = null;
}

document.getElementById("confirmYes").onclick = ()=>{
  if(confirmCallback) confirmCallback();
  closeConfirm();
};
document.getElementById("confirmNo").onclick = closeConfirm;
  
</script>
</body>
</html>
