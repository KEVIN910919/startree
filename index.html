<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>æ˜Ÿæ¨¹å·¥åŠï½œå·¥å–®èŠå¤©å®¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body{
  margin:0;
  font-family:system-ui;
  background:radial-gradient(circle at top,#45bfc2,#31999c,#1b6e73);
  color:#fff;
  min-height:100vh;
}
header{
  padding:14px 20px;
  background:linear-gradient(90deg,#31999c);
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 12px #0006;
}
#loginBox{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.25);
  backdrop-filter:blur(2px);
  z-index:1000;
}
.loginGlow{
  position:absolute;width:500px;height:500px;
  background:radial-gradient(circle,#7fffd4 0%,transparent 70%);
  filter:blur(80px);
  top:-200px;right:-200px;opacity:.5;
}
.loginCard{
  position:relative;
  background:rgba(10,40,42,.95);
  border-radius:20px;
  padding:42px 48px;
  width:420px;max-width:90%;
  text-align:center;
  box-shadow:0 30px 80px rgba(0,0,0,.45);
}
.layout{display:flex;height:calc(100vh - 60px);}
.sidebar{width:240px;background:#0f3f43;padding:10px;overflow-y:auto;}
.ticket{padding:10px;border-radius:10px;margin-bottom:6px;cursor:pointer;background:#145a60;}
.ticket.active{background:linear-gradient(135deg,#4fd2d5,#31999c);color:#08383b;font-weight:600;}
.main{flex:1;padding:20px;}
.card{background:rgba(10,40,42,.9);border-radius:18px;padding:16px;}
#messages{height:55vh;overflow-y:auto;background:#0b2e31;border-radius:12px;padding:12px;margin:10px 0;}
.msg{margin:6px 0;font-size:14px;display:flex;gap:6px;align-items:center;}
.site{color:#9af2f4;} .dc{color:#ffd38c;}
.tag{font-size:12px;padding:2px 6px;border-radius:6px;}
.tag.admin{background:#d9534f;}
.tag.artist{background:#4fd29a;}
.tag.client{background:#4fb5d2;}
#sendBar{display:flex;gap:8px;}
textarea{flex:1;background:#0b2e31;border:none;color:#fff;padding:10px;border-radius:10px;}
button{background:linear-gradient(135deg,#4fd2d5,#31999c);border:none;color:#053436;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;}
button.danger{background:linear-gradient(135deg,#e86a6a,#c73737);color:#fff;}
.actions{display:flex;gap:8px;margin:8px 0;}
.locked{opacity:.5;pointer-events:none;}
#confirmMask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999;}
.confirmBox{background:#0b3f42;padding:20px;border-radius:14px;width:280px;text-align:center;}
.confirmBtns{display:flex;gap:10px;justify-content:center;margin-top:14px;}
</style>
</head>
<body>
<header>
  <div>ğŸŒ² æ˜Ÿæ¨¹å·¥åŠï½œå§”è¨—å·¥å–®ç³»çµ±</div>
  <div id="userArea"></div>
</header>

<div id="loginBox" style="display:none;">
  <div class="loginGlow"></div>
  <div class="loginCard">
    <h2>ç™»å…¥æ˜Ÿæ¨¹å·¥åŠ</h2>
    <p>è«‹ä½¿ç”¨ Discord å¸³è™Ÿç™»å…¥ï¼Œä»¥åŒæ­¥å·¥å–®èˆ‡èŠå¤©ç³»çµ±ã€‚</p>
    <button onclick="login()">ä½¿ç”¨ Discord ç™»å…¥</button>
  </div>
</div>

<div class="layout" id="chatLayout" style="display:none;">
  <div class="sidebar">
    <h3>ğŸ“ æˆ‘çš„å·¥å–®</h3>
    <button style="width:100%;margin:6px 0" onclick="startCreateTicket()">
      â• å»ºç«‹å§”è¨—å·¥å–®
    </button>
    <div id="ticketList"></div>
  </div>
  <div class="main">
    <div class="card" id="chatCard">
      <div id="ticketInfo"></div>
      <div class="actions">
        <button class="danger" onclick="cancelTicket()">ğŸ›‘ ä¸­æ­¢å§”è¨—</button>
        <button class="danger" onclick="closeTicket()">ğŸ”’ çµå–®</button>
      </div>
      <div id="messages"></div>
      <div id="sendBar">
        <textarea id="msgInput" rows="2" placeholder="è¼¸å…¥è¨Šæ¯â€¦"></textarea>
        <button onclick="sendMsg()">é€å‡º</button>
      </div>
    </div>
  </div>
</div>

<div id="confirmMask" style="display:none;">
  <div class="confirmBox">
    <h3>ç¢ºèªæ“ä½œ</h3>
    <p id="confirmText"></p>
    <div class="confirmBtns">
      <button id="confirmYes">ç¢ºå®š</button>
      <button id="confirmNo" class="danger">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
const API="https://api.dreamlight.site";
let currentTicket=null,timer=null,lastId=0,seenIds=new Set();
let confirmCallback=null;

const loginBox=document.getElementById("loginBox");
const chatLayout=document.getElementById("chatLayout");
const userArea=document.getElementById("userArea");
const ticketList=document.getElementById("ticketList");
const messages=document.getElementById("messages");
const ticketInfo=document.getElementById("ticketInfo");
const chatCard=document.getElementById("chatCard");
const msgInput=document.getElementById("msgInput");
const sendBar=document.getElementById("sendBar");

function login(){window.open(API+"/auth/discord","dcLogin","width=500,height=700");}

window.addEventListener("message",(e)=>{
  if(e.data?.token){localStorage.setItem("token",e.data.token);checkLogin();}
});

async function checkLogin(){
  const token=localStorage.getItem("token");
  if(!token){loginBox.style.display="flex";chatLayout.style.display="none";return;}
  const r=await fetch(API+"/api/me",{headers:{Authorization:"Bearer "+token}});
  const d=await r.json();
  if(d.error){loginBox.style.display="flex";chatLayout.style.display="none";return;}
  loginBox.style.display="none";chatLayout.style.display="flex";
  userArea.innerHTML=`ğŸ‘¤ ${d.username} <button class="danger" onclick="logout()">ç™»å‡º</button>`;
  loadTicketList();
}
function logout(){localStorage.removeItem("token");location.reload();}

async function loadTicketList(){
  const token=localStorage.getItem("token");
  const r=await fetch(API+"/api/my-tickets",{headers:{Authorization:"Bearer "+token}});
  const rows=await r.json();ticketList.innerHTML="";
  if(!rows.length){ticketList.innerHTML="<div style='opacity:.7;padding:8px'>ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„å·¥å–®</div>";return;}
  rows.forEach((t,i)=>{
    const d=document.createElement("div");
    d.className="ticket";d.textContent=t.ticket_code;
    d.onclick=()=>selectTicket(t.ticket_code);
    ticketList.appendChild(d);if(i===0)selectTicket(t.ticket_code);
  });
}

function selectTicket(code){
  document.querySelectorAll(".ticket").forEach(d=>d.classList.toggle("active",d.textContent===code));
  loadChat(code);
}

function roleTag(r){
  if(r==="admin")return`<span class="tag admin">ç®¡ç†å“¡</span>`;
  if(r==="artist")return`<span class="tag artist">ç¹ªå¸«</span>`;
  return`<span class="tag client">å§”è¨—äºº</span>`;
}

async function loadChat(code){
  if(currentTicket===code)return;
  currentTicket=code;lastId=0;seenIds.clear();
  messages.innerHTML="";ticketInfo.innerHTML=`ç›®å‰å·¥å–®ï¼š<b>${code}</b>`;
  await refreshChat();if(timer)clearInterval(timer);timer=setInterval(refreshChat,3000);
}

async function refreshChat(){
  if(!currentTicket)return;await checkTicketStatus();
  const r=await fetch(API+`/api/chat/${currentTicket}?after=${lastId}`);
  const rows=await r.json();
  rows.forEach(m=>{
    if(seenIds.has(m.id))return;seenIds.add(m.id);
    const d=document.createElement("div");
    d.className="msg "+(m.from_site?"site":"dc");
    d.innerHTML=`${roleTag(m.role)} <b>${m.username}</b>ï¼š${m.content}`;
    messages.appendChild(d);lastId=Math.max(lastId,m.id);
  });
  if(rows.length)messages.scrollTop=messages.scrollHeight;
}

async function checkTicketStatus(){
  const token=localStorage.getItem("token");
  const r=await fetch(API+`/api/ticket/${currentTicket}/status`,{headers:{Authorization:"Bearer "+token}});
  const d=await r.json();
  if(d.status==="cancelled"||d.status==="archived")lockChat(d.status);
}

function lockChat(s){
  chatCard.classList.add("locked");
  msgInput.disabled=true;sendBar.querySelector("button").disabled=true;
  msgInput.placeholder=s==="cancelled"?"æ­¤å·¥å–®å·²ä¸­æ­¢":"æ­¤å·¥å–®å·²çµå–®";
}

async function sendMsg(){
  const v=msgInput.value.trim();if(!v||!currentTicket)return;
  const token=localStorage.getItem("token");msgInput.value="";
  await fetch(API+"/api/chat/send",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+token},
    body:JSON.stringify({ticket_code:currentTicket,content:v})});
}

function showConfirm(text,cb){
  confirmCallback=cb;
  document.getElementById("confirmText").textContent=text;
  document.getElementById("confirmMask").style.display="flex";
}
function closeConfirm(){
  document.getElementById("confirmMask").style.display="none";
  confirmCallback=null;
}
document.getElementById("confirmYes").onclick=()=>{if(confirmCallback)confirmCallback();closeConfirm();};
document.getElementById("confirmNo").onclick=closeConfirm;

function cancelTicket(){
  showConfirm("ç¢ºå®šè¦ä¸­æ­¢å§”è¨—ï¼Ÿ",async()=>{
    const token=localStorage.getItem("token");
    await fetch(API+"/api/ticket/cancel",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+token},
      body:JSON.stringify({ticket_code:currentTicket})});
    alert("å·²é€å‡ºä¸­æ­¢è«‹æ±‚");
  });
}
function closeTicket(){
  showConfirm("ç¢ºå®šè¦çµå–®ï¼Ÿ",async()=>{
    const token=localStorage.getItem("token");
    await fetch(API+"/api/ticket/close",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+token},
      body:JSON.stringify({ticket_code:currentTicket})});
    alert("å·²é€å‡ºçµå–®è«‹æ±‚");
  });
}

async function startCreateTicket(){
  const token = localStorage.getItem("token");
  const r = await fetch(API+"/api/check-guild",{
    headers:{Authorization:"Bearer "+token}
  });
  const d = await r.json();

  if(!d.in_guild){
    alert("è«‹å…ˆåŠ å…¥æ˜Ÿæ¨¹å·¥åŠ Discord ä¼ºæœå™¨ï¼Œæ‰èƒ½å»ºç«‹å§”è¨—ã€‚");
    return;
  }
  openCreateForm();
}

async function openCreateForm(){
  const r = await fetch(API+"/api/artists");
  const artists = await r.json();

  if(!artists.length){
    alert("ç›®å‰æ²’æœ‰å¯ç”¨ç¹ªå¸«");
    return;
  }

  let list = "è«‹é¸æ“‡ç¹ªå¸«ï¼š\n";
  artists.forEach((a,i)=>{
    list += `${i+1}. ${a.name}\n`;
  });

  const idx = prompt(list + "\nè¼¸å…¥æ•¸å­—é¸æ“‡ï¼š");
  const artist = artists[idx-1];
  if(!artist) return;

  const item = prompt("å§”è¨—é …ç›®ï¼š");
  if(!item) return;
  const method = prompt("å§”è¨—ç•«å¼ï¼š");
  const preference = prompt("åå¥½é¢¨æ ¼ï¼š");
  const budget = prompt("é ç®—ï¼š");
  const usage = prompt("ç”¨é€”ï¼š");

  submitCreate({
    artist_id: artist.id,
    item, method, preference, budget, usage
  });
}

async function submitCreate(data){
  const token = localStorage.getItem("token");
  const r = await fetch(API+"/api/ticket/create",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body: JSON.stringify(data)
  });
  const d = await r.json();

  if(d.error==="not_in_guild"){
    alert("ä½ ä¸åœ¨ Discord ä¼ºæœå™¨ä¸­ï¼Œç„¡æ³•å»ºç«‹å§”è¨—ã€‚");
    return;
  }

  if(d.ok){
    alert("å§”è¨—å·¥å–®å·²å»ºç«‹ï¼Œè«‹åˆ° Discord æŸ¥çœ‹ï¼");
    loadTicketList();
  }
}
  
document.addEventListener("DOMContentLoaded",checkLogin);
</script>
</body>
</html>
