<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ˜Ÿæ¨¹å·¥åŠï½œå·¥å–®èŠå¤©å®¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; background:#0f1115; color:#fff; margin:0; }
    header { padding:12px 16px; background:#171a22; display:flex; justify-content:space-between; align-items:center; }
    button { background:#5c7cff; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer; }
    button.danger{ background:#d14; }
    #loginBox, #chatBox { display:none; padding:16px; }
    #messages { height:60vh; overflow-y:auto; background:#111; padding:12px; border-radius:8px; }
    .msg{ margin:6px 0; }
    .site{ color:#7cf; }
    .dc{ color:#fc7; }
    #sendBar{ display:flex; gap:8px; margin-top:8px; }
    input, textarea{ flex:1; padding:8px; border-radius:6px; border:none; }
    select{ padding:8px; border-radius:6px; }
  </style>
</head>
<body>
<header>
  <div>ğŸŒ² æ˜Ÿæ¨¹å·¥åŠ å·¥å–®èŠå¤©å®¤</div>
  <div id="userArea"></div>
</header>

<div id="loginBox">
  <h2>ç™»å…¥</h2>
  <button onclick="login()">ä½¿ç”¨ Discord ç™»å…¥</button>
</div>

<div id="chatBox">
  <div style="margin-bottom:8px;">
    å·¥å–®ä»£ç¢¼ï¼š
    <input id="ticketInput" placeholder="ä¾‹å¦‚ COM-20260101010101" />
    <button onclick="loadChat()">è¼‰å…¥èŠå¤©</button>
  </div>

  <div id="messages"></div>

  <div id="sendBar">
    <textarea id="msgInput" rows="2" placeholder="è¼¸å…¥è¨Šæ¯..."></textarea>
    <button onclick="sendMsg()">é€å‡º</button>
  </div>
</div>

<script>
const API = "http://127.0.0.1:10001"; // ä¾ä½ å¾Œç«¯è¨­å®šä¿®æ”¹

// å–å¾— tokenï¼ˆURL æˆ– localStorageï¼‰
const params = new URLSearchParams(location.search);
if(params.get("token")){
  localStorage.setItem("token", params.get("token"));
  history.replaceState({}, "", location.pathname);
}
const token = localStorage.getItem("token");

const loginBox = document.getElementById("loginBox");
const chatBox = document.getElementById("chatBox");
const userArea = document.getElementById("userArea");

function login(){
  location.href = API + "/auth/discord";
}

function logout(){
  fetch(API+"/api/logout",{method:"POST",headers:{Authorization:"Bearer "+token}})
  .then(()=>{ localStorage.removeItem("token"); location.reload(); });
}

async function checkLogin(){
  if(!token){ showLogin(); return; }
  const r = await fetch(API+"/api/me",{headers:{Authorization:"Bearer "+token}});
  const d = await r.json();
  if(d.error){ showLogin(); return; }
  userArea.innerHTML = `ğŸ‘¤ ${d.username} <button class='danger' onclick='logout()'>ç™»å‡º</button>`;
  loginBox.style.display="none";
  chatBox.style.display="block";
}

function showLogin(){
  loginBox.style.display="block";
  chatBox.style.display="none";
  userArea.innerHTML="";
}

let currentTicket = null;
let timer = null;

async function loadChat(){
  const code = document.getElementById("ticketInput").value.trim();
  if(!code) return alert("è«‹è¼¸å…¥å·¥å–®ä»£ç¢¼");
  currentTicket = code;
  await refreshChat();
  if(timer) clearInterval(timer);
  timer = setInterval(refreshChat, 3000);
}

async function refreshChat(){
  if(!currentTicket) return;
  const r = await fetch(API+`/api/chat/${currentTicket}`);
  const rows = await r.json();
  const box = document.getElementById("messages");
  box.innerHTML = "";
  for(const m of rows){
    const div = document.createElement("div");
    div.className = "msg " + (m.from_site?"site":"dc");
    div.textContent = `[${m.username}] ${m.content}`;
    box.appendChild(div);
  }
  box.scrollTop = box.scrollHeight;
}

async function sendMsg(){
  const txt = document.getElementById("msgInput");
  const v = txt.value.trim();
  if(!v || !currentTicket) return;
  await fetch(API+"/api/chat/send",{
    method:"POST",
    headers:{"Content-Type":"application/json",Authorization:"Bearer "+token},
    body:JSON.stringify({ticket_code:currentTicket, content:v})
  });
  txt.value="";
  setTimeout(refreshChat,500);
}

checkLogin();
</script>
</body>
</html>
